name: Athlete Intake

on:
  repository_dispatch:
    types: [athlete-intake]
  workflow_dispatch:
    inputs:
      email:
        description: 'Athlete email'
        required: true
      athlete_id:
        description: 'Athlete ID'
        required: true

jobs:
  generate-plan:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout athlete-profiles
        uses: actions/checkout@v4
        with:
          path: athlete-profiles
          token: ${{ secrets.GH_PAT }}
      
      - name: Checkout gravel-landing-page-project
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: wattgod/gravel-landing-page-project
          token: ${{ secrets.GH_PAT }}
          path: gravel-landing-page-project
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml python-dateutil lxml openpyxl
          # Install jq for JSON processing
          sudo apt-get update && sudo apt-get install -y jq || echo "jq installation skipped"
      
      - name: Extract and save payload
        id: payload
        run: |
          # Initialize has_email to false by default
          echo "has_email=false" >> $GITHUB_OUTPUT
          
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "=== Full client_payload structure ==="
            echo '${{ toJson(github.event.client_payload) }}' | jq . || echo '${{ toJson(github.event.client_payload) }}'
            
            EMAIL="${{ github.event.client_payload.email }}"
            ATHLETE_ID="${{ github.event.client_payload.athlete_id }}"
            TIER="${{ github.event.client_payload.coaching_tier }}"
            NAME="${{ github.event.client_payload.name }}"
            
            echo ""
            echo "=== Extracted Values ==="
            echo "Email: '$EMAIL'"
            echo "Athlete ID: '$ATHLETE_ID'"
            echo "Tier: '$TIER'"
            echo "Name: '$NAME'"
            
            # Check if email is in the data object instead
            if [ -z "$EMAIL" ] || [ "$EMAIL" == "null" ] || [ "$EMAIL" == "" ]; then
              echo "‚ö†Ô∏è Email not in client_payload.email, checking client_payload.data.email"
              EMAIL_FROM_DATA=$(echo '${{ toJson(github.event.client_payload.data) }}' | jq -r '.email // empty' 2>/dev/null || echo "")
              if [ -n "$EMAIL_FROM_DATA" ] && [ "$EMAIL_FROM_DATA" != "null" ] && [ "$EMAIL_FROM_DATA" != "" ]; then
                EMAIL="$EMAIL_FROM_DATA"
                echo "‚úÖ Found email in data: $EMAIL"
              fi
            fi
            
            # Final validation - if still empty, set flag to skip emails
            if [ -z "$EMAIL" ] || [ "$EMAIL" == "null" ] || [ "$EMAIL" == "" ]; then
              echo "‚ö†Ô∏è WARNING: Email is empty after all checks!"
              echo "Available keys in client_payload:"
              echo '${{ toJson(github.event.client_payload) }}' | jq 'keys' || echo "Could not parse JSON"
              echo ""
              echo "Full payload for debugging:"
              echo '${{ toJson(github.event.client_payload) }}' | jq . || echo '${{ toJson(github.event.client_payload) }}'
              # Set email to empty and flag to skip
              EMAIL=""
              echo "has_email=false" >> $GITHUB_OUTPUT
            else
              echo "has_email=true" >> $GITHUB_OUTPUT
            fi
            
            echo "email=$EMAIL" >> $GITHUB_OUTPUT
            echo "athlete_id=$ATHLETE_ID" >> $GITHUB_OUTPUT
            echo "coaching_tier=$TIER" >> $GITHUB_OUTPUT
            echo "name=$NAME" >> $GITHUB_OUTPUT
            
            # Save full payload to file (use jq for proper JSON handling)
            echo '${{ toJson(github.event.client_payload.data) }}' | jq . > /tmp/form_data.json || {
              echo "Warning: jq not available, using direct JSON"
              echo '${{ toJson(github.event.client_payload.data) }}' > /tmp/form_data.json
            }
          else
            # Manual trigger - use test data
            MANUAL_EMAIL="${{ github.event.inputs.email }}"
            if [ -z "$MANUAL_EMAIL" ] || [ "$MANUAL_EMAIL" == "" ]; then
              echo "has_email=false" >> $GITHUB_OUTPUT
            else
              echo "has_email=true" >> $GITHUB_OUTPUT
            fi
            echo "email=$MANUAL_EMAIL" >> $GITHUB_OUTPUT
            echo "athlete_id=${{ github.event.inputs.athlete_id }}" >> $GITHUB_OUTPUT
            echo "coaching_tier=mid" >> $GITHUB_OUTPUT
            echo "name=Manual Test" >> $GITHUB_OUTPUT
            echo "is_manual=true" >> $GITHUB_OUTPUT
            
            # Create minimal test form data
            cat > /tmp/form_data.json << 'EOF'
          {
            "name": "Manual Test",
            "email": "${{ github.event.inputs.email }}",
            "coaching_tier": "mid",
            "birthday": "1986-01-15",
            "height_ft": "5",
            "height_in": "10",
            "weight_lbs": "165",
            "sex": "male",
            "primary_goal": "specific_race",
            "has_race_goal": "yes",
            "a_event_1_name": "Unbound 200",
            "a_event_1_date": "2026-06-07",
            "a_event_1_distance": "200",
            "a_event_1_goal": "compete",
            "years_cycling": "5",
            "weekly_hours": "12",
            "strength_sessions_max": "2",
            "ftp": "280",
            "weight_kg": "75",
            "strength_equipment": ["bodyweight", "dumbbells", "kettlebells"],
            "monday_availability": "available",
            "monday_time_slots": ["am"],
            "monday_max_duration": "90",
            "tuesday_availability": "available",
            "tuesday_time_slots": ["pm"],
            "tuesday_max_duration": "90",
            "tuesday_is_key_day_ok": "true",
            "wednesday_availability": "limited",
            "wednesday_time_slots": ["am"],
            "wednesday_max_duration": "60",
            "thursday_availability": "available",
            "thursday_time_slots": ["pm"],
            "thursday_max_duration": "90",
            "thursday_is_key_day_ok": "true",
            "friday_availability": "limited",
            "friday_time_slots": ["am"],
            "friday_max_duration": "45",
            "saturday_availability": "available",
            "saturday_time_slots": ["am"],
            "saturday_max_duration": "300",
            "saturday_is_key_day_ok": "true",
            "sunday_availability": "available",
            "sunday_time_slots": ["am"],
            "sunday_max_duration": "180"
          }
          EOF
          fi
          
          echo "Form data saved to /tmp/form_data.json"
          echo "=== First 500 chars of form data ==="
          cat /tmp/form_data.json | head -c 500 || echo "Error reading form_data.json"
          echo ""
          echo "=== Checking if form_data.json is valid JSON ==="
          python3 -m json.tool /tmp/form_data.json > /dev/null && echo "‚úÖ Valid JSON" || echo "‚ùå Invalid JSON"
      
      - name: Create athlete directory
        run: |
          athlete_id="${{ steps.payload.outputs.athlete_id }}"
          mkdir -p "athlete-profiles/athletes/${athlete_id}"
          cp /tmp/form_data.json "athlete-profiles/athletes/${athlete_id}/form_data.json"
      
      - name: Create athlete profile from form
        working-directory: athlete-profiles
        run: |
          echo "=== Creating profile for athlete: ${{ steps.payload.outputs.athlete_id }} ==="
          echo "=== Input file: athletes/${{ steps.payload.outputs.athlete_id }}/form_data.json ==="
          ls -la "athletes/${{ steps.payload.outputs.athlete_id }}/" || echo "Directory not found"
          python athletes/scripts/create_profile_from_form.py \
            --athlete-id "${{ steps.payload.outputs.athlete_id }}" \
            --input-file "athletes/${{ steps.payload.outputs.athlete_id }}/form_data.json" || {
              echo "‚ùå Profile creation failed"
              exit 1
            }
      
      - name: Validate profile
        working-directory: athlete-profiles
        run: python athletes/scripts/validate_profile.py "${{ steps.payload.outputs.athlete_id }}"
      
      - name: Derive classifications
        working-directory: athlete-profiles
        run: python athletes/scripts/derive_classifications.py "${{ steps.payload.outputs.athlete_id }}"
      
      - name: Build weekly structure
        working-directory: athlete-profiles
        run: python athletes/scripts/build_weekly_structure.py "${{ steps.payload.outputs.athlete_id }}"
      
      - name: Generate unified plan with strength
        env:
          PYTHONPATH: ${{ github.workspace }}/gravel-landing-page-project/races
        working-directory: athlete-profiles
        continue-on-error: true
        run: |
          echo "=== Generating unified plan with strength workouts ==="
          if [ -d "${{ github.workspace }}/gravel-landing-page-project" ]; then
            python athletes/scripts/generate_athlete_plan.py "${{ steps.payload.outputs.athlete_id }}"
          else
            echo "‚ö†Ô∏è Warning: gravel-landing-page-project not available, skipping plan generation"
            echo "This is expected if GH_PAT secret is not configured"
          fi
      
      - name: Generate athlete guide
        working-directory: athlete-profiles
        continue-on-error: true
        run: |
          if [ -f "athletes/${{ steps.payload.outputs.athlete_id }}/profile.yaml" ]; then
            python athletes/scripts/generate_athlete_guide.py "${{ steps.payload.outputs.athlete_id }}" || echo "‚ö†Ô∏è Guide generation failed, but profile is valid"
          else
            echo "‚ö†Ô∏è Profile not found, skipping guide generation"
          fi
      
      - name: Generate HTML guide
        working-directory: athlete-profiles
        continue-on-error: true
        run: |
          if [ -f "athletes/${{ steps.payload.outputs.athlete_id }}/profile.yaml" ]; then
            python athletes/scripts/generate_html_guide.py "${{ steps.payload.outputs.athlete_id }}" || echo "‚ö†Ô∏è HTML guide generation failed, but profile is valid"
          else
            echo "‚ö†Ô∏è Profile not found, skipping HTML guide generation"
          fi
      
      - name: Generate dashboard
        working-directory: athlete-profiles
        continue-on-error: true
        run: |
          if [ -f "athletes/${{ steps.payload.outputs.athlete_id }}/profile.yaml" ]; then
            python athletes/scripts/generate_dashboard.py "${{ steps.payload.outputs.athlete_id }}" || echo "‚ö†Ô∏è Dashboard generation failed, but profile is valid"
          else
            echo "‚ö†Ô∏è Profile not found, skipping dashboard generation"
          fi
      
      - name: List generated files
        working-directory: athlete-profiles
        run: |
          echo "=== Generated files ==="
          find "athletes/${{ steps.payload.outputs.athlete_id }}" -type f | head -50
          echo ""
          echo "=== Workout count ==="
          find "athletes/${{ steps.payload.outputs.athlete_id }}" -name "*.zwo" | wc -l || echo "0 ZWO files"
      
      - name: Commit generated plan
        working-directory: athlete-profiles
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          athlete_id="${{ steps.payload.outputs.athlete_id }}"
          
          git add "athletes/${athlete_id}/" || true
          git diff --staged --quiet || git commit -m "Add intake for ${athlete_id}"
          git push || echo "Nothing to push"
      
      - name: Send success email to athlete
        if: success() && steps.payload.outputs.has_email == 'true' && steps.payload.outputs.email != '' && steps.payload.outputs.email != 'null' && steps.payload.outputs.email != 'undefined'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Welcome to Gravel God Coaching - ${{ steps.payload.outputs.name || 'Athlete' }}"
          to: ${{ steps.payload.outputs.email }}
          from: Gravel God Cycling <${{ secrets.EMAIL_USERNAME }}>
          body: |
            Hi ${{ steps.payload.outputs.name }},
            
            Your coaching intake has been received and your personalized training plan is being prepared.
            
            SELECTED TIER: ${{ steps.payload.outputs.coaching_tier }}
            
            NEXT STEPS - Please complete these 3 steps:
            
            1. CONNECT TO MY TRAININGPEAKS COACH ACCOUNT
               Click here to attach your TrainingPeaks account:
               https://home.trainingpeaks.com/attachtocoach?sharedKey=2OTEPC6BXNVQU
            
            2. SUBSCRIBE TO YOUR COACHING PACKAGE
               Based on your selected tier (${{ steps.payload.outputs.coaching_tier }}), subscribe to the matching package:
               
               ‚Ä¢ Gravel Min ($199/4 weeks) - https://checkout.trainingpeaks.com/product/8a7865f1-c387-43b0-8b03-9efb6a15ebd5
               ‚Ä¢ Gravel Mid ($299/4 weeks) - https://checkout.trainingpeaks.com/product/9ea94d4d-2fea-4d40-af6a-7b9566391c3d
               ‚Ä¢ Gravel Max ($1,200/4 weeks) - https://checkout.trainingpeaks.com/product/7623fdc6-859d-4676-9567-f196028053a5
            
            3. SCHEDULE OUR FIRST MEETING
               Book your kickoff call here:
               https://calendar.app.google/E282ZtBJAFBXYdYJ6
            
            I'll review your intake within 24 hours and your initial plan will be ready shortly after you complete these steps.
            
            If you have questions, reply to this email.
            
            Let's get after it.
            
            ‚Äî Matti
            Gravel God Cycling
      
      - name: Notify admin of new intake
        if: success()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üéØ New Athlete Intake: ${{ steps.payload.outputs.name }}"
          to: ${{ secrets.ADMIN_EMAIL || 'gravelgodcoaching@gmail.com' }}
          from: Gravel God System <${{ secrets.EMAIL_USERNAME }}>
          body: |
            NEW ATHLETE INTAKE RECEIVED
            
            Name: ${{ steps.payload.outputs.name }}
            Email: ${{ steps.payload.outputs.email }}
            Athlete ID: ${{ steps.payload.outputs.athlete_id }}
            Coaching Tier: ${{ steps.payload.outputs.coaching_tier }}
            
            Plan Status: ‚úÖ Generated successfully
            
            View profile:
            https://github.com/${{ github.repository }}/tree/main/athletes/${{ steps.payload.outputs.athlete_id }}
            
            Workflow run:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            Review the intake and reach out within 24 hours.
      
      - name: Send failure notification
        if: failure() && steps.payload.outputs.has_email == 'true' && steps.payload.outputs.email != ''
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Issue with your Gravel God Coaching intake"
          to: ${{ steps.payload.outputs.email }}
          from: Gravel God Cycling <${{ secrets.EMAIL_USERNAME }}>
          body: |
            Hi ${{ steps.payload.outputs.name }},
            
            We encountered an issue processing your coaching intake.
            
            Please try submitting the form again at:
            https://wattgod.github.io/athlete-profiles/athlete-questionnaire.html
            
            If the problem persists, reply to this email and we'll help manually.
            
            ‚Äî Gravel God Cycling
      
      - name: Notify admin on failure
        if: failure()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[ALERT] Athlete intake failed: ${{ steps.payload.outputs.athlete_id }}"
          to: ${{ secrets.ADMIN_EMAIL }}
          from: Gravel God System <${{ secrets.EMAIL_USERNAME }}>
          body: |
            Athlete intake failed:
            
            Athlete ID: ${{ steps.payload.outputs.athlete_id }}
            Email: ${{ steps.payload.outputs.email }}
            Name: ${{ steps.payload.outputs.name }}
            Tier: ${{ steps.payload.outputs.coaching_tier }}
            
            Check the workflow run:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
